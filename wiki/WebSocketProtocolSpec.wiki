This is a note by pywebsocket developers for catching up changes on the spec and tracking discussion on !HyBi. This may also be useful for people who are interested in !WebSocket protocol design to quickly catch up the history of discussion on !HyBi and understand what/why/when a certain decision has been made.

= Official working drafts =

== !HyBi 05 ==

  * [http://tools.ietf.org/id/draft-ietf-hybi-thewebsocketprotocol-05.txt Spec]
  * [http://tools.ietf.org/rfcdiff?url2=draft-ietf-hybi-thewebsocketprotocol-05 Diff from 04]

=== Change ===

Major changes
  * Removed Sec-!WebSocket-Nonce
  * Changed masking : SHA-1, client nonce, server nonce, CSPRNG -> CSPRNG only
  * Specified the body of close frame explicitly
  * ABNF fix for origin and protocol
  * Added detailed Sec-!WebSocket-Extensions format specification

Typos, remanet removal
  * Removed all occurrence of Sec-!WebSocket-Location
  * Added IANA Sec-!WebSocket-Accept section

Trivial changes
  * The value of Sec-!WebSocket-Version is now 5

== !HyBi 04 ==

  * [http://tools.ietf.org/id/draft-ietf-hybi-thewebsocketprotocol-04.txt Spec]

=== Change ===

Major changes
  * Added frame masking
  * Changed opening handshake
    * Sec-!WebSocket-Key1, Sec-!WebSocket-Key2, key3, response -> Sec-!WebSocket-Key, Sec-!WebSocket-Nonce, Sec-!WebSocket-Accept)
  * Added Sec-!WebSocket-Extensions for extension negotiation
  * Upgrade header is now case-insensitive (HTTP compliant)
  * Flipped MORE bit and renamed it to FIN bit

Tiny changes
  * Renamed Sec-!WebSocket-Draft to Sec-!WebSocket-Version
  * Renamed Origin to Sec-!WebSocket-Origin
  * Added ABNF (one used in HTTP RFC2616) clarification to Sec-!WebSocket-Protocol
  * Changed subprotocols separator from SP to ','
  * Removed Sec-!WebSocket-Location

=== Library dependency ===

Introduced
  * BASE64
  * SHA-1

Eliminated
  * MD5

== !HyBi 03 ==

  * [http://tools.ietf.org/id/draft-ietf-hybi-thewebsocketprotocol-03.txt Spec]

=== Change ===

  * Added one known extension "compression"
  * Added close frame body matching step to closing handshake
    * To distinguish close frames among virtual channels in multiplexed connection

=== Library dependency ===

Introduced
  * DEFLATE

=== Note ===

  * The value of Sec-!WebSocket-Draft is still 2

== !HyBi 02 ==

  * [http://tools.ietf.org/id/draft-ietf-hybi-thewebsocketprotocol-02.txt Spec]

=== Change ===

  * Added /defer cookies/ flag
  * Added Sec-!WebSocket-Draft with a value of 2

== !HyBi 01 ==

  * [http://tools.ietf.org/id/draft-ietf-hybi-thewebsocketprotocol-01.txt Spec]

=== Change ===

  * Changed frame format
  * Added extension mechanism (no negotiation yet)

== Hixie 76 (!HyBi 00) ==

  * [http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-00 HyBi 00]
  * [http://tools.ietf.org/html/draft-hixie-thewebsocketprotocol-76 Hixie 76]

=== Change ===

  * Added challenge/response handshaking using binary data
  * Added closing handshake

=== Library dependency ===

Introduced
  * MD5

== Hixie 75 ==

  * [http://tools.ietf.org/html/draft-hixie-thewebsocketprotocol-75 Spec]

= Rationale =

== Use GET method ==

== What's Sec- ==

Prevent cross protocol attack using XMLHttpRequest. XMLHttpRequest interface doesn't allow us to send fields with Sec- prefix.

== Challenge/response in opening handshake ==

  * Prevent cross protocol attack
    * [http://www.ietf.org/mail-archive/web/hybi/current/msg01198.html Maciej's post]

== Use frame length, not sentinel based as Hixie 75 ==

  * Support binary frame
  * Use only one method to identify frame boundary to keep framing simple

== Fragmentation ===

  * Sending dynamically generated contents efficiently without queuing data until all the data of a message is available (without waiting until we know the size of application data that we need to write length field)
    * [http://www6.ietf.org/mail-archive/web/hybi/current/msg03759.html John's post] "As Greg mentioned, generating ..."
  * Necessary for multiplexing

  * Only FIN bit or combination of FIN bit and continuous opcode?

== 3-mode encoding on frame length field ==

  * Small overhead for short frame
  * Support huge frame (63 bit)
    * [http://www.ietf.org/mail-archive/web/hybi/current/msg03085.html Maciej's post]
  * 63 bit, not 64 bit since some environments doesn't support unsigned 64 bit data type
    * [http://www.ietf.org/mail-archive/web/hybi/current/msg03030.html Greg's post]
  * [https://www.google.com/moderator/#15/e=2809f&t=2809f.40&f=2809f.7beeb Informal poll on frame encoding schemes (Google Moderator)]
  * The number of reserved bits we can get was also the point of the argument

== Frame masking ==

  * !WebSocket can be abused to poisoning HTTP proxy unless we mask data so that attacker's script cannot control what is sent over TCP.
    * Lin-Shung et. al, Transparent Proxies: Threat or Menace? http://www.adambarth.com/experimental/websocket.pdf

== Closing handshake ==

  * [http://www.ietf.org/mail-archive/web/hybi/current/msg01137.html Prevent RST hazard] "Please note: The close-frame ..."
  * Allow a peer to confirm that the peer has received all data
  * Allow a peer to confirm that the other peer has received all data (This feature has been dropped)

  * [http://www.ietf.org/mail-archive/web/hybi/current/msg01526.html Use closing handshake instead of TCP shutdown] "I think the net result is ..."

== deflate-stream extension ==

  * [http://www.ietf.org/mail-archive/web/hybi/current/msg04117.html Revised proposal]
  * [http://www.ietf.org/mail-archive/web/hybi/current/msg04071.html First proposal by Patrick] Compress only applied to the application data portion

== Not NPN ==

  * SNI is not well deployed

== TLS only is not acceptable ==

  * TLS only, then no need to mask frame

No.

  * In some countries, censoring is required by law e.g. filtering porn in school

= Other proposals =

  * http://tools.ietf.org/id/draft-abarth-thewebsocketprotocol-01.txt Opening handshake with CONNECT method, AES based frame masking by Adam Barth
  * http://tools.ietf.org/html/draft-montenegro-hybi-upgrade-hello-handshake-00 Gabriel's proposal
  * http://www.whatwg.org/specs/web-socket-protocol/ Last proposal Hixie published before he took over editor to Ian Fette.

= References/Tools =

  * [http://www.ietf.org/mail-archive/web/hybi/current/maillist.html HyBi mailing list archive]
  * [https://datatracker.ietf.org/doc/draft-ietf-hybi-thewebsocketprotocol/history/ IETF datatracker] Useful for getting side-by-side diff between drafts
  * [http://trac.tools.ietf.org/wg/hybi/trac/log/websocket/draft-ietf-hybi-thewebsocketprotocol.xml Latest draft on IETF Subversion]
  * [http://trac.tools.ietf.org/wg/hybi/trac/wiki/HandshakeProposals Proposal list on HyBi wiki]